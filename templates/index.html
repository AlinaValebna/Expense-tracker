{% extends "base.html" %}
{% block content %}

<!-- FILTER -->
<form method="get" class="mb-3 d-flex gap-2 align-items-center">
  <label for="filter">View:</label>
  <select name="filter" id="filter" class="form-select w-auto" onchange="this.form.submit()">
    <option value="all" {% if filter=='all' %}selected{% endif %}>All</option>
    <option value="month" {% if filter=='month' %}selected{% endif %}>This Month</option>
    <option value="week" {% if filter=='week' %}selected{% endif %}>This Week</option>
  </select>
</form>

<!-- FINANCIAL SUMMARY -->
<div class="mb-4">
  <div class="card p-3">
    <h5 class="mb-2">üìä This Month</h5>
    <p><strong>Income:</strong> ${{ '%.2f' | format(income) }}</p>
    <p><strong>Expenses:</strong> ${{ '%.2f' | format(total_expenses) }}</p>
    <p>
      <strong>Net Balance:</strong>
      <span class="{% if net < 0 %}text-danger{% else %}text-success{% endif %}">
        ${{ '%.2f' | format(net) }}
      </span>
    </p>
  </div>
</div>

<!-- EXPENSES BY CATEGORY CHART -->
<div class="mt-4 mb-5">
  <h5>üßÅ Expenses Breakdown by Category</h5>
  <canvas id="expensesChart" width="400" height="400"></canvas>
</div>

<script>
  const ctx = document.getElementById('expensesChart').getContext('2d');
  const expensesChart = new Chart(ctx, {
    type: 'pie',
    data: {
      labels: {{ chart_labels | tojson }},
  datasets: [{
    data: {{ chart_data | tojson }},
    backgroundColor: [
    '#4A90E2', '#50E3C2', '#F5A623', '#F8E71C',
    '#B8E986', '#BD10E0', '#FF6F61', '#7ED6DF'
  ],
    borderWidth: 1
      }]
    },
  options: {
    responsive: true,
      plugins: {
      legend: { position: 'bottom' },
      tooltip: {
        callbacks: {
          label: function(context) {
            return `${context.label}: $${context.parsed}`;
          }
        }
      }
    }
  }
  });
</script>


<!-- NAV TO SAVINGS GOALS -->
<div class="mb-4">
  <a href="{{ url_for('goals') }}" class="btn btn-outline-primary">üí∞ View Savings Goals</a>
</div>
<!-- EMBEDDED GOALS PREVIEW -->
<h5 class="mt-4">Top Savings Goals</h5>
{% if goals %}
{% for goal in goals %}
<div class="mb-3 p-3 border rounded">
  <div class="d-flex justify-content-between">
    <strong>{{ goal.name }}</strong>
    <span>${{ '%.2f' | format(goal.saved_amount) }} / ${{ '%.2f' | format(goal.target_amount) }}</span>
  </div>
  <div class="progress mt-2" style="height: 18px;">
    <div class="progress-bar bg-info" style="width: {{ (goal.saved_amount / goal.target_amount * 100) | round(1) }}%;">
      {{ (goal.saved_amount / goal.target_amount * 100) | round(1) }}%
    </div>
  </div>
</div>
{% endfor %}
<a href="{{ url_for('goals') }}" class="btn btn-outline-secondary btn-sm">View All Goals ‚Üí</a>
{% else %}
<p class="text-muted">No savings goals yet. <a href="{{ url_for('goals') }}">Create one ‚Üí</a></p>
{% endif %}

<!-- EXPENSE LIST -->
<ul class="list-group">
  {% for expense in expenses %}
  <li class="list-group-item d-flex justify-content-between align-items-center">
    <div>
      <strong>${{ '%.2f' | format(expense.amount) }}</strong> ‚Äì
      {{ expense.description }}
      <span class="text-muted">({{ expense.category }})</span>
    </div>
    <div class="d-flex gap-2 align-items-center">
      <small class="text-muted">{{ expense.date.strftime('%Y-%m-%d') }}</small>
      <a href="{{ url_for('delete_expense', expense_id=expense.id) }}" class="btn btn-sm btn-danger">Delete</a>
    </div>
  </li>
  {% else %}
  <li class="list-group-item text-muted">No expenses found.</li>
  {% endfor %}
</ul>

<!-- ADD EXPENSE BUTTON -->
<div class="mt-4">
  <a href="{{ url_for('add_expense') }}" class="btn btn-success">‚ûï Add Expense</a>
</div>

{% endblock %}